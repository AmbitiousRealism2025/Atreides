# OmO to Claude Code Conversion: Master Implementation Plan

## Executive Summary

This master plan provides a comprehensive, phased roadmap for converting Oh My OpenCode (OmO) orchestration patterns to Claude Code. Based on analysis of ~350 KB of research documentation across 31 files, this plan identifies 6 implementation phases progressing from package architecture through advanced feature adaptation.

**Project Name**: Muad'Dib - OmO-style orchestration for Claude Code

**Overall Migration Assessment:**
- **Complexity Score**: 7/10
- **Feature Parity Target**: 75-80%
- **Total Effort**: 10-14 days (MVP: 6-8 days)
- **Risk Level**: Medium (mitigated through phased approach)
- **Distribution**: NPM package with global + project installation

---

## Plan Architecture

```
PHASE 0: Package Architecture (Foundation)
├── Package structure design (global vs project)
├── NPM package setup (muaddib-claude)
├── Installation scripts (install, init, update)
├── Directory structure templates
└── Exit Criteria: Distributable package ready

PHASE 1: MVP Foundation (P0 Critical)
├── Core CLAUDE.md orchestration rules
├── TodoWrite integration
├── 3-Strikes error recovery
├── Basic agent delegation
└── Exit Criteria: Functional orchestration baseline

PHASE 2: Core Orchestration (P1 High Priority)
├── Intent classification system
├── 7-section delegation template
├── Model selection rules
├── Basic quality hooks
├── Codebase maturity assessment
└── Exit Criteria: Intelligent task routing operational

PHASE 3: Full Workflow Implementation (P2 Medium Priority)
├── Multi-phase workflow (0-3)
├── Exploration phase with parallel agents
├── Completion checking mechanism
├── Session continuity patterns
├── Context management strategies
└── Exit Criteria: Complete workflow operational

PHASE 4: Enhanced Capabilities (P3 Nice-to-Have)
├── Extended hook configurations
├── Advanced permission patterns
├── Notification integrations
├── Helper script ecosystem
└── Exit Criteria: 70%+ OmO parity achieved

PHASE 5: Difficult Feature Adaptations
├── LSP MCP integration
├── AST-grep CLI integration
├── Advanced context preservation
├── Extended automation patterns
└── Exit Criteria: Maximum achievable parity

ACKNOWLEDGED LIMITATIONS (Impossible Features)
├── Dynamic MCP server spawning
├── Multi-model concurrency (cross-provider)
├── DCP algorithm control
├── Agent demotion logic
└── Tiered concurrency control
```

---

## Phase 0: Package Architecture

**Priority**: Foundation (Required First)
**Estimated Effort**: 1-2 days
**Dependencies**: None (true foundation phase)

### 0.1 Goals and Outcomes

**Primary Goal**: Create a distributable package architecture that allows Muad'Dib to be installed globally and initialized per-project, similar to how OmO works as a plugin for OpenCode.

**Success Criteria**:
- [ ] NPM package structure created
- [ ] Global installation working (`npm install -g muaddib-claude`)
- [ ] Project initialization working (`muaddib init`)
- [ ] Clear separation between global and project files
- [ ] Update mechanism functional

### 0.2 Package Architecture Design

#### 0.2.1 Two-Layer Installation Model

```
GLOBAL LAYER (Installed Once - ~/.muaddib/)
├── bin/
│   ├── muaddib              # Main CLI entry point
│   ├── muaddib-install      # Global installation script
│   └── muaddib-update       # Update script
├── lib/
│   ├── core/
│   │   ├── orchestration-rules.md    # Core Muad'Dib rules (template)
│   │   ├── agent-definitions.md      # Agent delegation patterns
│   │   └── workflow-phases.md        # Workflow documentation
│   ├── hooks/
│   │   └── settings-template.json    # Base hooks configuration
│   ├── scripts/
│   │   ├── validate-bash-command.sh
│   │   ├── pre-edit-check.sh
│   │   ├── post-edit-log.sh
│   │   ├── error-detector.sh
│   │   └── notify-idle.sh
│   └── templates/
│       ├── CLAUDE.md.template        # Project CLAUDE.md template
│       ├── context.md.template       # Context injection template
│       └── critical-context.md.template
├── skills/
│   └── muaddib/
│       └── SKILL.md                  # Core Muad'Dib skill
└── package.json

PROJECT LAYER (Per-Project - Generated by `muaddib init`)
├── CLAUDE.md                    # Generated from template + project context
├── .claude/
│   ├── settings.json            # Merged: global defaults + project overrides
│   ├── context.md               # Project-specific context
│   ├── critical-context.md      # Project-specific critical context
│   └── scripts/                 # Symlinks to global scripts (or copies)
└── .muaddib/
    ├── config.json              # Project-specific Muad'Dib config
    └── state/                   # Session state, checkpoints
```

#### 0.2.2 Installation Flow

```
┌─────────────────────────────────────────────────────────────┐
│                    GLOBAL INSTALLATION                       │
│                                                             │
│  npm install -g muaddib-claude                              │
│         │                                                   │
│         ▼                                                   │
│  Creates ~/.muaddib/ with:                                  │
│  • CLI tools (muaddib, muaddib-install, muaddib-update)    │
│  • Core library files                                       │
│  • Script templates                                         │
│  • Skill definitions                                        │
│         │                                                   │
│         ▼                                                   │
│  Adds ~/.muaddib/bin to PATH                               │
│  Symlinks to ~/.claude/skills/muaddib (optional)           │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                    PROJECT INITIALIZATION                    │
│                                                             │
│  cd /path/to/project                                        │
│  muaddib init                                               │
│         │                                                   │
│         ▼                                                   │
│  Interactive prompts (optional):                            │
│  • Project name                                             │
│  • Project type (Node/Python/Go/Rust/etc.)                 │
│  • Codebase maturity (Disciplined/Transitional/Legacy/New) │
│  • Enable strict mode? (more guardrails)                   │
│         │                                                   │
│         ▼                                                   │
│  Generates:                                                 │
│  • CLAUDE.md (from template + answers)                     │
│  • .claude/settings.json (merged config)                   │
│  • .claude/context.md (project-specific)                   │
│  • .muaddib/config.json (project config)                   │
└─────────────────────────────────────────────────────────────┘
```

#### 0.2.3 CLI Commands

| Command | Description |
|---------|-------------|
| `muaddib install` | Install/reinstall global components |
| `muaddib init` | Initialize Muad'Dib in current project |
| `muaddib init --minimal` | Minimal init (just CLAUDE.md) |
| `muaddib init --full` | Full init with all features |
| `muaddib update` | Update global components to latest |
| `muaddib update --project` | Update project files to match global |
| `muaddib doctor` | Check installation health |
| `muaddib config` | View/edit configuration |
| `muaddib reset` | Reset project to default state |

### 0.3 Deliverables

#### 0.3.1 NPM Package Structure

```
muaddib-claude/
├── package.json
├── README.md
├── LICENSE
├── bin/
│   └── muaddib.js           # CLI entry point
├── src/
│   ├── cli/
│   │   ├── index.js         # CLI router
│   │   ├── install.js       # Global install command
│   │   ├── init.js          # Project init command
│   │   ├── update.js        # Update command
│   │   ├── doctor.js        # Health check command
│   │   └── config.js        # Config command
│   ├── lib/
│   │   ├── file-manager.js  # File operations
│   │   ├── template-engine.js # Template processing
│   │   ├── config-merger.js # Config merging logic
│   │   └── validator.js     # Installation validation
│   └── utils/
│       ├── logger.js        # Logging utilities
│       └── prompts.js       # Interactive prompts
├── templates/
│   ├── CLAUDE.md.hbs        # Handlebars template
│   ├── settings.json.hbs    # Settings template
│   ├── context.md.hbs       # Context template
│   └── config.json.hbs      # Project config template
├── scripts/
│   ├── validate-bash-command.sh
│   ├── pre-edit-check.sh
│   ├── post-edit-log.sh
│   ├── error-detector.sh
│   └── notify-idle.sh
└── lib/
    ├── core/
    │   ├── orchestration-rules.md
    │   ├── agent-definitions.md
    │   └── workflow-phases.md
    └── skills/
        └── muaddib/
            └── SKILL.md
```

#### 0.3.2 package.json

```json
{
  "name": "muaddib-claude",
  "version": "1.0.0",
  "description": "OmO-style orchestration for Claude Code",
  "keywords": ["claude", "claude-code", "ai", "orchestration", "omo"],
  "author": "Your Name",
  "license": "MIT",
  "bin": {
    "muaddib": "./bin/muaddib.js"
  },
  "main": "./src/lib/index.js",
  "files": [
    "bin/",
    "src/",
    "templates/",
    "scripts/",
    "lib/"
  ],
  "scripts": {
    "test": "jest",
    "lint": "eslint src/",
    "postinstall": "node ./src/cli/install.js --auto"
  },
  "dependencies": {
    "commander": "^11.0.0",
    "handlebars": "^4.7.8",
    "inquirer": "^9.0.0",
    "chalk": "^5.3.0",
    "fs-extra": "^11.0.0"
  },
  "devDependencies": {
    "jest": "^29.0.0",
    "eslint": "^8.0.0"
  },
  "engines": {
    "node": ">=18.0.0"
  }
}
```

#### 0.3.3 CLAUDE.md Template (Handlebars)

```handlebars
# {{projectName}} - Muad'Dib Orchestration

## Core Identity

You are an AI assistant following Muad'Dib orchestration patterns for Claude Code.
This project uses systematic workflows, intelligent agent delegation, and robust error recovery.

**Project Type**: {{projectType}}
**Codebase Maturity**: {{maturity}}
**Muad'Dib Version**: {{version}}

---

## Orchestration Rules

{{> orchestration-rules}}

---

## Workflow Phases

{{> workflow-phases}}

---

## Agent Delegation

{{> agent-definitions}}

---

## Project-Specific Context

{{#if projectContext}}
{{{projectContext}}}
{{else}}
[Add project-specific context here]
{{/if}}

---

## File Patterns

{{#if filePatterns}}
{{{filePatterns}}}
{{else}}
[Document your project's file patterns and conventions]
{{/if}}

---

*Generated by Muad'Dib v{{version}}*
*Based on OmO orchestration patterns*
```

#### 0.3.4 Configuration Merging Logic

```javascript
// config-merger.js - Conceptual structure
const mergeConfigs = (globalConfig, projectConfig) => {
  return {
    hooks: {
      // Global hooks are base
      ...globalConfig.hooks,
      // Project hooks override/extend
      ...projectConfig.hooks,
      // Special merge for arrays (PostToolUse, etc.)
      PostToolUse: [
        ...(globalConfig.hooks?.PostToolUse || []),
        ...(projectConfig.hooks?.PostToolUse || [])
      ]
    },
    permissions: {
      allow: [
        ...(globalConfig.permissions?.allow || []),
        ...(projectConfig.permissions?.allow || [])
      ],
      deny: [
        ...(globalConfig.permissions?.deny || []),
        ...(projectConfig.permissions?.deny || [])
      ]
    }
  };
};
```

### 0.4 Implementation Tasks

| Task ID | Task | Effort | Dependency |
|---------|------|--------|------------|
| 0.1.1 | Design final package structure | 1 hour | None |
| 0.1.2 | Create package.json with dependencies | 30 min | 0.1.1 |
| 0.1.3 | Set up project scaffolding | 30 min | 0.1.2 |
| 0.2.1 | Implement CLI router (commander.js) | 1 hour | 0.1.3 |
| 0.2.2 | Implement `muaddib install` command | 1 hour | 0.2.1 |
| 0.2.3 | Implement `muaddib init` command | 2 hours | 0.2.1 |
| 0.2.4 | Implement `muaddib update` command | 1 hour | 0.2.2 |
| 0.2.5 | Implement `muaddib doctor` command | 45 min | 0.2.1 |
| 0.3.1 | Create CLAUDE.md.hbs template | 1 hour | 0.1.3 |
| 0.3.2 | Create settings.json.hbs template | 30 min | 0.1.3 |
| 0.3.3 | Create context templates | 30 min | 0.1.3 |
| 0.3.4 | Implement template engine | 1 hour | 0.3.1 |
| 0.4.1 | Implement config merger | 1 hour | 0.1.3 |
| 0.4.2 | Implement file manager utilities | 45 min | 0.1.3 |
| 0.5.1 | Create helper scripts | 30 min | 0.1.3 |
| 0.5.2 | Create core documentation files | 1 hour | 0.1.3 |
| 0.6.1 | Test global installation flow | 30 min | All |
| 0.6.2 | Test project initialization flow | 30 min | 0.6.1 |
| 0.6.3 | Test update mechanism | 30 min | 0.6.2 |
| 0.7.1 | Write README documentation | 1 hour | All |
| 0.7.2 | Prepare for npm publish | 30 min | 0.7.1 |

**Total Phase 0 Effort**: ~15-18 hours (2 days)

### 0.5 Validation Checklist

- [ ] `npm install -g muaddib-claude` completes without errors
- [ ] `muaddib --version` returns version number
- [ ] `muaddib doctor` reports healthy installation
- [ ] `muaddib init` in empty directory creates expected files
- [ ] `muaddib init` in existing project doesn't overwrite files without confirmation
- [ ] Generated CLAUDE.md contains all required sections
- [ ] Generated settings.json has valid hook configuration
- [ ] Scripts are executable and work on macOS/Linux
- [ ] `muaddib update` pulls latest templates
- [ ] Config merging works correctly (global + project)

### 0.6 Exit Criteria

Phase 0 is complete when:
1. NPM package can be installed globally
2. `muaddib init` successfully scaffolds a project
3. Generated files match expected structure
4. Update mechanism works
5. Documentation is complete for installation and usage

---

## Phase 1: MVP Foundation

**Priority**: P0 Critical (Must Have)
**Estimated Effort**: 1-2 days
**Dependencies**: Phase 0 complete (package structure exists)

### 1.1 Goals and Outcomes

**Primary Goal**: Establish functional orchestration baseline that delivers 70% of OmO's value with minimal effort.

**Success Criteria**:
- [ ] Multi-step tasks tracked via TodoWrite
- [ ] Error recovery protocol triggers correctly
- [ ] Agent delegation functional via Task tool
- [ ] CLAUDE.md rules followed during sessions

### 1.2 Deliverables

#### 1.2.1 Core CLAUDE.md File

Create the foundational project orchestration document with these sections:

**A. Core Identity Section**
- Define Claude Code as following OmO-style orchestration
- Establish systematic workflow expectations
- Set quality and completion standards

**B. Task Management Rules**
- TodoWrite for 3+ step tasks (mandatory)
- Atomic deliverable per todo item
- Complete only when verified
- Never stop with incomplete todos
- Progress visibility requirements

**C. Error Recovery Protocol (3-Strikes Rule)**
```
Strike 1 → Attempt operation
Strike 2 → Retry with adjustments
Strike 3 → Retry again
         │
         ▼ (3rd failure)
    ┌─────────┐
    │  STOP   │ → Halt all modifications
    └────┬────┘
         │
    ┌─────────┐
    │ REVERT  │ → git checkout (last working state)
    └────┬────┘
         │
    ┌─────────┐
    │DOCUMENT │ → Record failure details
    └────┬────┘
         │
    ┌─────────┐
    │ CONSULT │ → Task(Plan, opus) for guidance
    └────┬────┘
         │
    ┌─────────┐
    │ESCALATE │ → AskUserQuestion if still stuck
    └─────────┘
```

**D. Basic Agent Delegation Matrix**
| Task Type | subagent_type | model |
|-----------|---------------|-------|
| Codebase exploration | Explore | haiku |
| Research/documentation | general-purpose | haiku |
| Architecture decisions | Plan | opus |
| Implementation | (direct) | - |

**E. Quality Standards**
- Run linters before marking edits complete
- No TODO comments for core functionality
- Follow existing code style exactly
- Test when infrastructure exists

#### 1.2.2 Basic settings.json Configuration

Create `.claude/settings.json` with:
- Empty hooks structure (placeholder for Phase 2)
- Basic permission patterns
- Deny list for dangerous operations

```json
{
  "permissions": {
    "deny": [
      "Bash(rm -rf:*)",
      "Bash(curl:*)",
      "Bash(wget:*)",
      "Read(.env)",
      "Read(./secrets/**)"
    ]
  }
}
```

#### 1.2.3 Project Directory Structure

```
project-root/
├── CLAUDE.md                    # Orchestration rules
├── .claude/
│   ├── settings.json            # Hooks and permissions
│   └── context.md               # Injected context (optional)
└── [existing project files]
```

### 1.3 Implementation Tasks

| Task ID | Task | Effort | Dependency |
|---------|------|--------|------------|
| 1.1.1 | Create CLAUDE.md core identity section | 15 min | None |
| 1.1.2 | Add task management rules | 10 min | 1.1.1 |
| 1.1.3 | Add 3-strikes error recovery protocol | 15 min | 1.1.1 |
| 1.1.4 | Add basic agent delegation matrix | 10 min | 1.1.1 |
| 1.1.5 | Add quality standards section | 10 min | 1.1.1 |
| 1.2.1 | Create .claude directory | 2 min | None |
| 1.2.2 | Create settings.json with deny list | 10 min | 1.2.1 |
| 1.3.1 | Test TodoWrite integration | 15 min | 1.1.2 |
| 1.3.2 | Test 3-strikes protocol manually | 20 min | 1.1.3 |
| 1.3.3 | Test Task delegation | 15 min | 1.1.4 |

**Total Phase 1 Effort**: ~2 hours

### 1.4 Validation Checklist

- [ ] CLAUDE.md loads correctly at session start
- [ ] TodoWrite used automatically for 3+ step tasks
- [ ] Error recovery referenced when failures occur
- [ ] Task delegation uses correct subagent_types
- [ ] Quality standards followed during implementation

### 1.5 Exit Criteria

Phase 1 is complete when:
1. A new session references CLAUDE.md rules
2. Multi-step tasks are tracked via TodoWrite
3. 3-strikes protocol is documented and understood
4. Basic Task delegation works (Explore, general-purpose)

---

## Phase 2: Core Orchestration

**Priority**: P1 High Priority
**Estimated Effort**: 2 days
**Dependencies**: Phase 1 complete

### 2.1 Goals and Outcomes

**Primary Goal**: Enable intelligent task routing with intent classification and optimized delegation.

**Success Criteria**:
- [ ] Requests classified before action
- [ ] 7-section delegation template in use
- [ ] Cost-aware model selection operational
- [ ] Basic quality hooks running

### 2.2 Deliverables

#### 2.2.1 Intent Classification System

Add to CLAUDE.md - Phase 0: Intent Gate equivalent:

**Request Classifications**:
| Category | Description | Action |
|----------|-------------|--------|
| **Trivial** | Simple questions, quick lookups | Direct answer, no tools |
| **Explicit** | Clear implementation request | Execute immediately |
| **Exploratory** | Requires investigation | Launch exploration agents |
| **Open-ended** | Architectural decisions | Full codebase assessment |
| **Ambiguous** | Unclear requirements | AskUserQuestion first |

**Classification Rules**:
```markdown
## Before Starting Any Task

1. CLASSIFY the request type:
   - Does it require code changes? (Explicit)
   - Does it require research? (Exploratory)
   - Is it unclear what's wanted? (Ambiguous)
   - Is it a simple question? (Trivial)

2. For AMBIGUOUS requests:
   - DO NOT proceed without clarification
   - Use AskUserQuestion to clarify:
     - Expected outcomes
     - Scope boundaries
     - Success criteria

3. For EXPLORATORY requests:
   - Launch Task(Explore) before implementation
   - Gather context systematically
   - Confirm understanding before changes
```

#### 2.2.2 7-Section Delegation Template

Add comprehensive delegation format to CLAUDE.md:

```markdown
## Agent Delegation Template

When delegating via Task tool, structure prompts as:

### 1. TASK
[Specific, atomic goal - single deliverable]

### 2. EXPECTED OUTCOME
[Concrete, verifiable deliverables]

### 3. CONTEXT
- Files: [relevant file paths]
- Patterns: [existing conventions to follow]
- Constraints: [limitations, boundaries]

### 4. MUST DO
- [Explicit requirement 1]
- [Explicit requirement 2]
- [Explicit requirement 3]

### 5. MUST NOT DO
- [Forbidden action 1]
- [Forbidden action 2]
- Do NOT modify files outside scope
- Do NOT spawn additional agents

### 6. TOOLS ALLOWED (optional)
[Whitelist of permitted tools if constraining]

### 7. SUCCESS CRITERIA
[How to know the task is complete]
```

#### 2.2.3 Model Selection Rules

Add cost-optimization guidelines:

```markdown
## Model Selection Guidelines

| Task Complexity | Model | Rationale |
|-----------------|-------|-----------|
| Simple exploration, file search | haiku | Fast, cheap, sufficient |
| Standard implementation | sonnet | Balanced capability/cost |
| Architecture, complex analysis | opus | Maximum reasoning |

### Selection Rules:

1. **Default to haiku** for:
   - Codebase exploration (Task(Explore))
   - Simple research queries
   - File pattern searches
   - Quick lookups

2. **Use sonnet** for:
   - Implementation tasks
   - Code generation
   - Documentation writing
   - Standard complexity work

3. **Reserve opus** for:
   - Architecture decisions
   - Complex debugging
   - Strategic planning
   - Error recovery consultation
```

#### 2.2.4 Basic Quality Hooks

Update `.claude/settings.json`:

```json
{
  "hooks": {
    "PostToolUse": [
      {
        "matcher": "Edit|Write",
        "hooks": [
          {
            "type": "command",
            "command": "prettier --write \"$FILE\" 2>/dev/null || true"
          },
          {
            "type": "command",
            "command": "eslint --fix \"$FILE\" 2>/dev/null || true"
          }
        ]
      }
    ]
  },
  "permissions": {
    "allow": [
      "Bash(git:*)",
      "Bash(npm run:*)",
      "Bash(npm test:*)",
      "Bash(npx:*)"
    ],
    "deny": [
      "Bash(rm -rf:*)",
      "Bash(curl:*)",
      "Bash(wget:*)",
      "Read(.env)",
      "Read(./secrets/**)"
    ]
  }
}
```

#### 2.2.5 Codebase Maturity Assessment

Add to CLAUDE.md:

```markdown
## Codebase Maturity Classification

At project start, assess and document:

| Level | Indicators | Approach |
|-------|------------|----------|
| **DISCIPLINED** | Consistent patterns, good tests, clear structure | Follow existing patterns EXACTLY |
| **TRANSITIONAL** | Mix of old/new patterns, partial coverage | Gradual migration, respect legacy |
| **LEGACY** | Inconsistent, technical debt, few tests | Propose cleanups when relevant |
| **GREENFIELD** | New project, no existing patterns | Establish new best practices |

### Document in CLAUDE.md:
```
## Project Maturity: [DISCIPLINED/TRANSITIONAL/LEGACY/GREENFIELD]

Based on assessment of:
- Test coverage: [high/medium/low/none]
- Code consistency: [consistent/mixed/inconsistent]
- Documentation: [comprehensive/partial/minimal]
- Pattern adherence: [strict/flexible/none]
```
```

### 2.3 Implementation Tasks

| Task ID | Task | Effort | Dependency |
|---------|------|--------|------------|
| 2.1.1 | Add intent classification section to CLAUDE.md | 20 min | P1 |
| 2.1.2 | Add classification decision rules | 15 min | 2.1.1 |
| 2.2.1 | Add 7-section delegation template | 20 min | P1 |
| 2.2.2 | Create example delegations for each agent type | 30 min | 2.2.1 |
| 2.3.1 | Add model selection rules | 15 min | P1 |
| 2.3.2 | Add cost tier documentation | 10 min | 2.3.1 |
| 2.4.1 | Add PostToolUse hooks for formatting | 15 min | P1 |
| 2.4.2 | Add PostToolUse hooks for linting | 15 min | 2.4.1 |
| 2.4.3 | Test hook execution | 20 min | 2.4.2 |
| 2.5.1 | Add maturity assessment section | 15 min | P1 |
| 2.5.2 | Create maturity assessment checklist | 15 min | 2.5.1 |
| 2.6.1 | Integration test: classification → delegation | 30 min | All |

**Total Phase 2 Effort**: ~4 hours

### 2.4 Validation Checklist

- [ ] Intent classification occurs before task start
- [ ] Ambiguous requests trigger AskUserQuestion
- [ ] Delegation prompts follow 7-section template
- [ ] Model selection matches task complexity
- [ ] PostToolUse hooks fire on Edit/Write operations
- [ ] Codebase maturity documented and referenced

### 2.5 Exit Criteria

Phase 2 is complete when:
1. Requests are classified before action
2. All delegations use 7-section template
3. Model selection is cost-aware
4. Quality hooks run automatically
5. Project maturity is documented

---

## Phase 3: Full Workflow Implementation

**Priority**: P2 Medium Priority
**Estimated Effort**: 2-3 days
**Dependencies**: Phase 2 complete

### 3.1 Goals and Outcomes

**Primary Goal**: Implement complete multi-phase workflow equivalent to Muad'Dib orchestration.

**Success Criteria**:
- [ ] All 4 workflow phases operational
- [ ] Parallel exploration agents working
- [ ] Completion checking prevents premature stops
- [ ] Session state persists appropriately

### 3.2 Deliverables

#### 3.2.1 Multi-Phase Workflow System

Add complete workflow documentation to CLAUDE.md:

```markdown
## Workflow Phases

### Phase 0: Intent Gate
**Purpose**: Classify and validate request before work begins

**Actions**:
1. Classify request type (Trivial/Explicit/Exploratory/Open-ended/Ambiguous)
2. For Ambiguous: AskUserQuestion for clarification
3. For Exploratory/Open-ended: Proceed to Phase 1
4. For Explicit: Skip to Phase 2B
5. For Trivial: Answer directly

**Gate Criteria**:
- Request is clearly understood
- Scope is defined
- Success criteria are known

---

### Phase 1: Codebase Assessment
**Purpose**: Evaluate project state for complex tasks

**Triggers**: Open-ended requests, unfamiliar codebases

**Actions**:
1. Assess codebase maturity (DISCIPLINED/TRANSITIONAL/LEGACY/GREENFIELD)
2. Identify existing patterns via Task(Explore)
3. Check dependencies (package.json, requirements.txt)
4. Understand project structure

**Gate Criteria**:
- Maturity level documented
- Key patterns identified
- Dependencies understood

---

### Phase 2A: Exploration & Research
**Purpose**: Gather context through parallel investigation

**Triggers**: Exploratory requests, insufficient context

**Actions**:
1. Launch parallel exploration agents:
   - Task(Explore, haiku) for internal codebase search
   - Task(general-purpose, haiku) for external research
2. Continue until:
   - Sufficient context gathered, OR
   - Information converges (same findings from multiple sources), OR
   - Iteration limit reached (2 searches with no new data)

**Parallel Execution Pattern**:
```
┌────────────────────────────────────┐
│ Launch in SINGLE message:          │
│ • Task(Explore) - internal search  │
│ • Task(general-purpose) - external │
└────────────────────────────────────┘
```

**Gate Criteria**:
- Relevant files identified
- Patterns understood
- Dependencies mapped
- External docs reviewed if needed

---

### Phase 2B: Implementation
**Purpose**: Execute the actual development work

**Actions**:
1. Create TodoWrite items for multi-step work
2. Handle core logic directly
3. Delegate specialized work:
   - UI/Frontend → Task(frontend-architect)
   - Documentation → Task(technical-writer)
   - Complex analysis → Task(Plan, opus)
4. Track progress via TodoWrite
5. Validate each step before proceeding

**Implementation Rules**:
- Follow existing patterns exactly
- Run quality checks after edits
- Mark todos complete only when verified
- Never leave code in broken state

---

### Phase 2C: Failure Recovery
**Purpose**: Handle persistent failures

**Trigger**: 3 consecutive failures on same operation

**Protocol**:
1. STOP - Halt all modifications immediately
2. REVERT - `git checkout` to last working state
3. DOCUMENT - Record failure details in response
4. CONSULT - Task(Plan, opus) for new strategy
5. ESCALATE - AskUserQuestion if still stuck

**Recovery Rules**:
- Never continue hoping errors will resolve
- Never disable tests to make them pass
- Always investigate root cause
- Document lessons learned

---

### Phase 3: Completion
**Purpose**: Verify and deliver results

**Actions**:
1. Verify all TodoWrite items complete
2. Run quality checks:
   - Linters pass
   - Type checks pass (if applicable)
   - Tests pass (if applicable)
3. Verify deliverables match requirements
4. Clean up temporary files/states
5. Summarize what was accomplished

**Gate Criteria**:
- All todos marked complete
- Quality checks pass
- Deliverables verified
- User informed of completion
```

#### 3.2.2 Exploration Phase Implementation

Create exploration patterns documentation:

```markdown
## Exploration Phase Patterns

### Parallel Agent Pattern

When exploration is needed, launch agents in a SINGLE message:

```
Task(
  subagent_type="Explore",
  model="haiku",
  prompt="Search this codebase for [specific pattern]. Return file paths and relevant code snippets."
)

Task(
  subagent_type="general-purpose",
  model="haiku",
  prompt="Research [external topic]. Return key findings and documentation links."
)
```

### Convergent Search Strategy

Continue exploration until:
1. **Convergence**: Same information found from multiple sources
2. **Sufficiency**: Enough context to proceed confidently
3. **Iteration Limit**: 2 searches with no new useful information

### Exploration Scope Rules

| Scope | What to Search | Tools |
|-------|----------------|-------|
| Internal | Files, patterns, dependencies | Glob, Grep, Read |
| External | Docs, libraries, APIs | WebFetch, WebSearch |
| Structure | Architecture, relationships | Task(Explore) |
```

#### 3.2.3 Completion Checking Mechanism

Add to CLAUDE.md:

```markdown
## Completion Checking Protocol

### Before Ending ANY Multi-Step Task:

1. **TodoWrite Audit**
   - Are ALL todos marked complete?
   - Were any skipped or forgotten?
   - If incomplete todos exist: CONTINUE, do not stop

2. **Quality Verification**
   - Did linters pass?
   - Did type checks pass?
   - Did tests pass (if applicable)?
   - If any failed: FIX before completing

3. **Deliverable Check**
   - Does output match requirements?
   - Were all requested changes made?
   - Is code in working state?
   - If gaps exist: ADDRESS before completing

4. **State Verification**
   - Is codebase in clean state?
   - Are there uncommitted changes that should be committed?
   - Are temporary files cleaned up?

### Completion Rules

- NEVER stop with incomplete todos
- NEVER stop with failing tests
- NEVER stop with broken code
- ALWAYS verify deliverables match request
- ALWAYS summarize what was accomplished
```

#### 3.2.4 Session Continuity Patterns

Add state persistence guidelines:

```markdown
## Session Continuity

### State Persistence Methods

1. **TodoWrite Persistence**
   - Todos persist across conversation
   - Always check for existing todos at session start
   - Resume incomplete work from prior sessions

2. **File-Based State**
   - Store critical decisions in project files
   - Document progress in CLAUDE.md or dedicated files
   - Reference file paths, not memory

3. **Context Preservation**
   - Summarize findings before context grows large
   - Store key information in project files
   - Keep CLAUDE.md updated with project state

### Session Start Protocol

1. Read CLAUDE.md for project context
2. Check for existing todos
3. Review recent changes (git status, git log)
4. Resume from last known state

### Session End Protocol

1. Ensure all todos complete or documented
2. Summarize progress in response
3. Note any pending work
4. Leave codebase in clean state
```

#### 3.2.5 Context Management Strategies

Add manual DCP equivalent:

```markdown
## Context Management

### Proactive Context Preservation

Since automatic context management is limited:

1. **Summarize Early**
   - After exploration: summarize key findings
   - After implementation: summarize what changed
   - Before context grows: capture critical info

2. **File-Based Memory**
   - Store decisions in project files
   - Reference paths, not full content
   - Keep CLAUDE.md as source of truth

3. **Structured Responses**
   - Use concise bullet points
   - Avoid unnecessary verbosity
   - Focus on actionable information

### Critical Context Preservation

Always preserve:
- Current task objectives
- File paths being modified
- Key decisions and rationale
- Error history and resolutions

### Context Pressure Signs

If responses are being truncated:
1. Summarize current state immediately
2. Store critical info in files
3. Simplify remaining work
4. Complete current task before new work
```

### 3.3 Implementation Tasks

| Task ID | Task | Effort | Dependency |
|---------|------|--------|------------|
| 3.1.1 | Add Phase 0 (Intent Gate) documentation | 20 min | P2 |
| 3.1.2 | Add Phase 1 (Assessment) documentation | 20 min | 3.1.1 |
| 3.1.3 | Add Phase 2A (Exploration) documentation | 25 min | 3.1.2 |
| 3.1.4 | Add Phase 2B (Implementation) documentation | 20 min | 3.1.3 |
| 3.1.5 | Add Phase 2C (Recovery) documentation | 15 min | 3.1.4 |
| 3.1.6 | Add Phase 3 (Completion) documentation | 15 min | 3.1.5 |
| 3.2.1 | Add parallel agent patterns | 20 min | 3.1.3 |
| 3.2.2 | Add convergent search strategy | 15 min | 3.2.1 |
| 3.3.1 | Add completion checking protocol | 25 min | 3.1.6 |
| 3.3.2 | Add completion rules | 15 min | 3.3.1 |
| 3.4.1 | Add session start protocol | 15 min | P2 |
| 3.4.2 | Add session end protocol | 15 min | 3.4.1 |
| 3.5.1 | Add context management strategies | 20 min | P2 |
| 3.5.2 | Add critical context preservation rules | 15 min | 3.5.1 |
| 3.6.1 | Test complete workflow: Phase 0 → Phase 3 | 45 min | All |
| 3.6.2 | Test parallel exploration | 30 min | 3.2.1 |
| 3.6.3 | Test completion checking | 30 min | 3.3.1 |

**Total Phase 3 Effort**: ~6-7 hours

### 3.4 Validation Checklist

- [ ] Phase 0 classification works correctly
- [ ] Phase 1 assessment triggers for complex tasks
- [ ] Phase 2A parallel agents execute in single message
- [ ] Phase 2B tracks progress via TodoWrite
- [ ] Phase 2C triggers after 3 failures
- [ ] Phase 3 verification prevents premature completion
- [ ] Session continuity works across conversations
- [ ] Context management prevents information loss

### 3.5 Exit Criteria

Phase 3 is complete when:
1. All 4 workflow phases documented and operational
2. Parallel exploration pattern works
3. Completion checking prevents early stops
4. Session state persists appropriately
5. Context management strategies in use

---

## Phase 4: Enhanced Capabilities

**Priority**: P3 Nice-to-Have
**Estimated Effort**: 2-3 days
**Dependencies**: Phase 3 complete

### 4.1 Goals and Outcomes

**Primary Goal**: Maximize OmO feature parity within Claude Code constraints.

**Success Criteria**:
- [ ] Extended hooks ecosystem operational
- [ ] Helper scripts created and working
- [ ] Permission patterns refined
- [ ] Notification system integrated
- [ ] 70%+ OmO parity achieved

### 4.2 Deliverables

#### 4.2.1 Extended Hook Configurations

Expand `.claude/settings.json`:

```json
{
  "hooks": {
    "PreToolUse": [
      {
        "matcher": "Bash",
        "hooks": [{
          "type": "command",
          "command": "scripts/validate-bash-command.sh \"$COMMAND\""
        }]
      },
      {
        "matcher": "Edit|Write",
        "hooks": [{
          "type": "command",
          "command": "scripts/pre-edit-check.sh \"$FILE\""
        }]
      }
    ],
    "PostToolUse": [
      {
        "matcher": "Edit|Write",
        "hooks": [
          {"type": "command", "command": "prettier --write \"$FILE\" 2>/dev/null || true"},
          {"type": "command", "command": "eslint --fix \"$FILE\" 2>/dev/null || true"},
          {"type": "command", "command": "scripts/post-edit-log.sh \"$FILE\""}
        ]
      },
      {
        "matcher": "*",
        "hooks": [{
          "type": "command",
          "command": "scripts/error-detector.sh \"$TOOL_OUTPUT\" 2>/dev/null || true"
        }]
      }
    ],
    "SessionStart": [{
      "hooks": [{
        "type": "command",
        "command": "cat .claude/context.md 2>/dev/null || true"
      }]
    }],
    "Stop": [{
      "hooks": [{
        "type": "command",
        "command": "scripts/notify-idle.sh"
      }]
    }],
    "PreCompact": [{
      "hooks": [{
        "type": "command",
        "command": "cat .claude/critical-context.md 2>/dev/null || true"
      }]
    }]
  }
}
```

#### 4.2.2 Helper Script Ecosystem

Create `.claude/scripts/` directory with:

**A. validate-bash-command.sh**
```bash
#!/bin/bash
# Validates bash commands before execution
COMMAND="$1"

# Block dangerous patterns
if [[ "$COMMAND" =~ "rm -rf /" ]] || \
   [[ "$COMMAND" =~ "dd if=" ]] || \
   [[ "$COMMAND" =~ "> /dev/" ]]; then
  echo "BLOCKED: Dangerous command pattern detected"
  exit 1
fi

exit 0
```

**B. pre-edit-check.sh**
```bash
#!/bin/bash
# Pre-edit validation
FILE="$1"

# Check if file exists
if [[ ! -f "$FILE" ]]; then
  echo "Warning: Creating new file: $FILE"
fi

# Check if file is in .gitignore patterns that shouldn't be edited
if [[ "$FILE" =~ ".env" ]] || [[ "$FILE" =~ "secrets" ]]; then
  echo "BLOCKED: Cannot edit sensitive file: $FILE"
  exit 1
fi

exit 0
```

**C. post-edit-log.sh**
```bash
#!/bin/bash
# Log edits for tracking
FILE="$1"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
echo "$TIMESTAMP: Edited $FILE" >> .claude/edit-log.txt
```

**D. error-detector.sh**
```bash
#!/bin/bash
# Detect errors in tool output
OUTPUT="$1"

# Check for common error patterns
if [[ "$OUTPUT" =~ "Error:" ]] || \
   [[ "$OUTPUT" =~ "error:" ]] || \
   [[ "$OUTPUT" =~ "FAILED" ]] || \
   [[ "$OUTPUT" =~ "Exception" ]]; then
  echo "WARNING: Potential error detected in output"
  # Log for review
  echo "$(date): Error detected" >> .claude/error-log.txt
fi

exit 0
```

**E. notify-idle.sh**
```bash
#!/bin/bash
# Notification when Claude stops

# macOS
if command -v osascript &> /dev/null; then
  osascript -e 'display notification "Claude Code session idle" with title "Claude Code"'
fi

# Linux (if notify-send available)
if command -v notify-send &> /dev/null; then
  notify-send "Claude Code" "Session idle"
fi
```

#### 4.2.3 Advanced Permission Patterns

Update permissions in settings.json:

```json
{
  "permissions": {
    "allow": [
      "Bash(git:*)",
      "Bash(npm:*)",
      "Bash(npx:*)",
      "Bash(yarn:*)",
      "Bash(pnpm:*)",
      "Bash(node:*)",
      "Bash(python:*)",
      "Bash(python3:*)",
      "Bash(pytest:*)",
      "Bash(cargo:*)",
      "Bash(go:*)",
      "Bash(make:*)",
      "Bash(docker:*)",
      "Bash(kubectl:*)",
      "Bash(ls:*)",
      "Bash(cat:*)",
      "Bash(head:*)",
      "Bash(tail:*)",
      "Bash(grep:*)",
      "Bash(find:*)",
      "Bash(which:*)",
      "Bash(pwd:*)",
      "Bash(echo:*)"
    ],
    "deny": [
      "Bash(rm -rf /*:*)",
      "Bash(rm -rf ~:*)",
      "Bash(curl:*)",
      "Bash(wget:*)",
      "Bash(chmod 777:*)",
      "Bash(sudo:*)",
      "Bash(su:*)",
      "Read(.env*)",
      "Read(**/secrets/**)",
      "Read(**/.git/config)",
      "Write(.env*)",
      "Write(**/secrets/**)"
    ]
  }
}
```

#### 4.2.4 Context Injection File

Create `.claude/context.md`:

```markdown
# Project Context (Auto-Injected at Session Start)

## Project Overview
[Brief project description]

## Current State
[Current development phase, active work areas]

## Key Patterns
[Important patterns to follow]

## Recent Decisions
[Recent architectural or implementation decisions]

## Active Work
[Currently active tasks or todos]

---
*This file is injected at session start via SessionStart hook*
```

#### 4.2.5 Critical Context Preservation File

Create `.claude/critical-context.md`:

```markdown
# Critical Context (Preserved During Compaction)

## Never Forget
[Absolutely critical information that must survive compaction]

## Current Objectives
[Current task objectives]

## Key File Paths
[Important file paths being worked on]

## Decisions Made
[Key decisions that inform current work]

---
*This file is injected during PreCompact hook*
```

### 4.3 Implementation Tasks

| Task ID | Task | Effort | Dependency |
|---------|------|--------|------------|
| 4.1.1 | Expand hooks configuration | 30 min | P3 |
| 4.1.2 | Add PreToolUse hooks | 20 min | 4.1.1 |
| 4.1.3 | Add SessionStart hook | 10 min | 4.1.1 |
| 4.1.4 | Add Stop hook | 10 min | 4.1.1 |
| 4.1.5 | Add PreCompact hook | 10 min | 4.1.1 |
| 4.2.1 | Create scripts directory | 5 min | P3 |
| 4.2.2 | Create validate-bash-command.sh | 20 min | 4.2.1 |
| 4.2.3 | Create pre-edit-check.sh | 15 min | 4.2.1 |
| 4.2.4 | Create post-edit-log.sh | 10 min | 4.2.1 |
| 4.2.5 | Create error-detector.sh | 15 min | 4.2.1 |
| 4.2.6 | Create notify-idle.sh | 15 min | 4.2.1 |
| 4.2.7 | Make all scripts executable | 5 min | 4.2.2-4.2.6 |
| 4.3.1 | Update permissions with allow list | 20 min | P3 |
| 4.3.2 | Update permissions with deny list | 15 min | 4.3.1 |
| 4.4.1 | Create context.md template | 15 min | P3 |
| 4.4.2 | Create critical-context.md template | 15 min | 4.4.1 |
| 4.5.1 | Test all hooks fire correctly | 30 min | All |
| 4.5.2 | Test script execution | 20 min | 4.2.7 |
| 4.5.3 | Test permission enforcement | 20 min | 4.3.2 |
| 4.5.4 | Test context injection | 15 min | 4.4.2 |

**Total Phase 4 Effort**: ~5-6 hours

### 4.4 Validation Checklist

- [ ] All 8 hook types configured appropriately
- [ ] Helper scripts execute without errors
- [ ] Permissions block dangerous operations
- [ ] Permissions allow safe operations
- [ ] Context injected at session start
- [ ] Critical context preserved during compaction
- [ ] Notifications fire on session stop
- [ ] Edit logging tracks changes

### 4.5 Exit Criteria

Phase 4 is complete when:
1. Extended hook ecosystem operational
2. All helper scripts working
3. Permission patterns refined and tested
4. Context injection working
5. Notification system integrated
6. ~70% OmO parity achieved

---

## Phase 5: Difficult Feature Adaptations

**Priority**: P3 Extended / High Effort
**Estimated Effort**: 3-5 days
**Dependencies**: Phase 4 complete

### 5.1 Goals and Outcomes

**Primary Goal**: Implement high-effort features that significantly enhance capability.

**Success Criteria**:
- [ ] LSP operations available (via MCP or CLI)
- [ ] AST-grep integration working
- [ ] Advanced context preservation operational
- [ ] Extended automation patterns implemented
- [ ] Maximum achievable parity reached

### 5.2 Deliverables

#### 5.2.1 LSP MCP Integration

**Option A: Existing LSP MCP Server**

Research and configure existing LSP MCP servers:

```json
{
  "mcpServers": {
    "lsp-typescript": {
      "command": "npx",
      "args": ["@anthropic/mcp-server-lsp", "--language", "typescript"]
    }
  }
}
```

**Option B: CLI-Based LSP Alternative**

Add to CLAUDE.md:

```markdown
## Semantic Code Operations

Since native LSP is limited, use CLI alternatives:

### TypeScript/JavaScript
- Type checking: `npx tsc --noEmit`
- References: `grep -r "import.*from.*[module]"`
- Definitions: Read source files directly

### Python
- Type checking: `mypy [file]` or `pyright [file]`
- References: `grep -r "from [module] import\|import [module]"`

### Go
- Type checking: `go vet`
- References: `go doc`, `grep`

### General Pattern
When semantic operation needed:
1. Use Bash with language-specific CLI tools
2. Parse output for relevant information
3. Follow up with Read for details
```

#### 5.2.2 AST-grep CLI Integration

Add AST-grep patterns to CLAUDE.md:

```markdown
## AST-grep Integration

### Installation Check
```bash
which ast-grep || echo "Install: npm install -g @ast-grep/cli"
```

### Usage Patterns

**Search for pattern:**
```bash
ast-grep --pattern '$PATTERN' --lang [language] [path]
```

**Replace pattern:**
```bash
ast-grep --pattern '$OLD' --rewrite '$NEW' --lang [language] [path]
```

### Common Operations

| Operation | Command |
|-----------|---------|
| Find function calls | `ast-grep --pattern '$FUNC($$$ARGS)' --lang ts src/` |
| Find imports | `ast-grep --pattern 'import $$$' --lang ts src/` |
| Find class definitions | `ast-grep --pattern 'class $NAME { $$$BODY }' --lang ts src/` |
| Replace console.log | `ast-grep --pattern 'console.log($$$)' --rewrite '' --lang ts src/` |

### Language Support (25 languages)
TypeScript, JavaScript, Python, Go, Rust, Java, C, C++, Ruby, PHP, Swift, Kotlin, Scala, and more.

### Dry Run First
Always use `--debug-query` or review matches before replace:
```bash
ast-grep --pattern '$PATTERN' --lang ts src/ --json
```
```

#### 5.2.3 Advanced Context Preservation

Enhance context management:

```markdown
## Advanced Context Preservation

### Checkpoint System

Before any risky operation:
1. Document current state in `.claude/checkpoint.md`
2. Note files being modified
3. Capture key decisions
4. Create git checkpoint if appropriate

### Checkpoint Template (.claude/checkpoint.md)
```markdown
# Session Checkpoint
Date: [timestamp]

## Current Objective
[What we're trying to accomplish]

## Files Modified
- [file1] - [what changed]
- [file2] - [what changed]

## Decisions Made
- [decision 1]
- [decision 2]

## Next Steps
- [step 1]
- [step 2]

## Recovery Instructions
If session is lost:
1. [How to resume]
2. [What to check]
```

### Automatic Checkpointing Triggers
- Before multi-file refactoring
- Before significant architectural changes
- Every 30 minutes of active work
- Before any operation marked as risky
```

#### 5.2.4 Extended Automation Patterns

Create advanced workflow patterns:

```markdown
## Extended Automation Patterns

### Pattern: Test-Driven Implementation
```
1. Write/update test (expect failure)
2. Run test, confirm failure
3. Implement to pass test
4. Run test, confirm pass
5. Refactor if needed
6. Run test, confirm still pass
```

### Pattern: Parallel Exploration + Sequential Implementation
```
Phase A (Parallel):
├── Task(Explore): Search codebase
├── Task(general-purpose): Research externally
└── Wait for both to complete

Phase B (Sequential):
├── Synthesize findings
├── Create implementation plan
├── Execute implementation
└── Validate results
```

### Pattern: Incremental Refactoring
```
For each file in scope:
1. Read current implementation
2. Identify refactoring target
3. Create todo for this file
4. Apply refactoring
5. Run tests
6. If pass: mark complete, continue
   If fail: fix or revert, then continue
```

### Pattern: Documentation Sync
```
After implementation complete:
1. Identify affected documentation
2. Update inline comments
3. Update README if needed
4. Update API docs if needed
5. Verify documentation accuracy
```
```

### 5.3 Implementation Tasks

| Task ID | Task | Effort | Dependency |
|---------|------|--------|------------|
| 5.1.1 | Research available LSP MCP servers | 2 hours | P4 |
| 5.1.2 | Configure LSP MCP (if available) | 1 hour | 5.1.1 |
| 5.1.3 | Document CLI-based LSP alternatives | 1 hour | P4 |
| 5.1.4 | Test LSP operations | 1 hour | 5.1.2/5.1.3 |
| 5.2.1 | Verify ast-grep installation | 15 min | P4 |
| 5.2.2 | Document ast-grep search patterns | 30 min | 5.2.1 |
| 5.2.3 | Document ast-grep replace patterns | 30 min | 5.2.2 |
| 5.2.4 | Create ast-grep cheat sheet | 30 min | 5.2.3 |
| 5.2.5 | Test ast-grep operations | 30 min | 5.2.4 |
| 5.3.1 | Create checkpoint system documentation | 30 min | P4 |
| 5.3.2 | Create checkpoint.md template | 20 min | 5.3.1 |
| 5.3.3 | Add checkpoint triggers to CLAUDE.md | 20 min | 5.3.2 |
| 5.4.1 | Document test-driven pattern | 20 min | P4 |
| 5.4.2 | Document parallel+sequential pattern | 20 min | 5.4.1 |
| 5.4.3 | Document incremental refactoring pattern | 20 min | 5.4.2 |
| 5.4.4 | Document documentation sync pattern | 15 min | 5.4.3 |
| 5.5.1 | Integration test: LSP operations | 45 min | 5.1.4 |
| 5.5.2 | Integration test: ast-grep workflow | 30 min | 5.2.5 |
| 5.5.3 | Integration test: checkpoint system | 30 min | 5.3.3 |
| 5.5.4 | Integration test: automation patterns | 45 min | 5.4.4 |

**Total Phase 5 Effort**: ~12-15 hours

### 5.4 Validation Checklist

- [ ] LSP operations work (MCP or CLI)
- [ ] AST-grep search patterns function
- [ ] AST-grep replace patterns function
- [ ] Checkpoint system documents state
- [ ] Advanced patterns documented and usable
- [ ] All integration tests pass

### 5.5 Exit Criteria

Phase 5 is complete when:
1. LSP operations available through some mechanism
2. AST-grep fully integrated
3. Advanced context preservation working
4. Extended automation patterns documented
5. Maximum achievable parity reached (~75-80%)

---

## Acknowledged Limitations

These OmO features **cannot be replicated** in Claude Code and are explicitly excluded from implementation:

### 1. Dynamic MCP Server Spawning
- **OmO**: SkillMcpManager spawns servers on-demand
- **Claude Code**: All servers must be pre-configured
- **Impact**: Medium - Increases resource usage
- **Mitigation**: Pre-configure all needed servers

### 2. Multi-Model Concurrency (Cross-Provider)
- **OmO**: Different providers (Anthropic, OpenAI, Google) in parallel
- **Claude Code**: Single provider (Anthropic)
- **Impact**: Medium - Loses specialized model capabilities
- **Mitigation**: Use model parameter for Claude variants (haiku/sonnet/opus)

### 3. DCP Algorithm Control
- **OmO**: Configurable 70%/85% thresholds with selective pruning
- **Claude Code**: Only ~95% auto-compact, no user control
- **Impact**: Medium - Less predictable context management
- **Mitigation**: PreCompact hook + proactive summarization

### 4. Agent Demotion Logic
- **OmO**: Automatic fallback to cheaper model on failure
- **Claude Code**: No automatic model switching
- **Impact**: Low-Medium - Manual retry needed
- **Mitigation**: Document fallback strategy, manual retry

### 5. Tiered Concurrency Control
- **OmO**: Per-provider limits (3 Anthropic, 10 Google)
- **Claude Code**: Flat 10-task limit
- **Impact**: Low - May hit rate limits occasionally
- **Mitigation**: Accept flat limit, monitor for issues

### 6. 23+ Missing Hook Events
- **OmO**: 31+ lifecycle events
- **Claude Code**: 8 events
- **Impact**: Medium-High - Reduced automation
- **Mitigation**: Implement behavior in CLAUDE.md rules

### 7. True Context Isolation
- **OmO**: Background agents in isolated contexts
- **Claude Code**: Task results enter parent context
- **Impact**: Medium - Context may grow faster
- **Mitigation**: Request summarized results only

### 8. Native LSP Integration (Full)
- **OmO**: 11 built-in LSP operations
- **Claude Code**: Limited native support
- **Impact**: High - Loses safe refactoring
- **Mitigation**: MCP servers or CLI alternatives

---

## Risk Assessment and Mitigation

### High Risk Areas

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Context loss during compaction | HIGH | HIGH | PreCompact hook + critical-context.md + proactive summarization |
| Hook complexity causes errors | MEDIUM | MEDIUM | Start simple, iterate; thorough testing |
| Permission misconfig blocks work | MEDIUM | LOW | Test permissions thoroughly; maintain allow list |
| Multi-phase workflow too complex | MEDIUM | MEDIUM | Simplify if needed; focus on key phases |
| LSP/AST integration fails | MEDIUM | MEDIUM | Have CLI fallbacks documented |

### Rollback Plan

If migration causes issues:

1. **Quick Rollback** (hooks causing problems)
   - Remove problematic hooks from settings.json
   - Keep CLAUDE.md rules intact
   - Test without hooks

2. **Partial Rollback** (specific features)
   - Disable specific features in CLAUDE.md
   - Simplify workflow to core phases
   - Remove advanced patterns

3. **Full Rollback** (complete reset)
   - Remove .claude/settings.json entirely
   - Simplify CLAUDE.md to essentials
   - Fall back to vanilla Claude Code

---

## Success Metrics

### Package Success (Phase 0)
| Metric | Target |
|--------|--------|
| Global installation success rate | 100% |
| Project initialization success rate | 100% |
| Cross-platform compatibility | macOS + Linux |
| CLI commands functional | All 9 commands |
| Template generation accuracy | 100% |

### MVP Success (Phase 0-2)
| Metric | Target |
|--------|--------|
| Task completion rate | >90% |
| Error recovery triggers correctly | 100% |
| Multi-step tasks tracked | 100% |
| Basic delegation working | >80% |
| Package installable by others | Yes |

### Full Conversion Success (Phase 0-5)
| Metric | Target |
|--------|--------|
| OmO feature coverage | >70% |
| All workflow phases operational | Yes |
| Context management effective | >80% |
| Semantic operations available | Yes (via MCP/CLI) |
| Hook automation working | >90% |
| Package published to npm | Yes |
| Documentation complete | Yes |

---

## Implementation Timeline

### Recommended Schedule

```
Week 1:
├── Day 1-2: Phase 0 (Package Architecture)
│   └── DISTRIBUTABLE PACKAGE READY
├── Day 3-4: Phase 1 (MVP Foundation)
└── Day 5-6: Phase 2 (Core Orchestration)
    └── MVP COMPLETE

Week 2:
├── Day 7-9: Phase 3 (Full Workflow)
└── Day 10-11: Phase 4 (Enhanced Capabilities)
    └── 70% PARITY ACHIEVED

Week 3:
└── Day 12-14: Phase 5 (Difficult Adaptations)
    └── FULL CONVERSION COMPLETE (75-80% parity)
```

### Milestone Checkpoints

| Milestone | Phase | Deliverable |
|-----------|-------|-------------|
| M0: Package Ready | 0 | NPM package, CLI tools, templates |
| M1: MVP Foundation | 1 | Core CLAUDE.md + settings.json |
| M2: Core Orchestration | 2 | Intent classification + delegation |
| M3: Full Workflow | 3 | All 4 workflow phases operational |
| M4: Enhanced | 4 | 70% parity + hooks ecosystem |
| M5: Maximum Parity | 5 | 75-80% parity + LSP/AST tools |

---

## Next Steps

After master plan approval:

1. **Phase 0 Context Document**: Create detailed Phase 0 implementation context (package architecture)
2. **Task Breakdown**: Break Phase 0 into individual executable tasks
3. **Begin Implementation**: Execute Phase 0 tasks (create distributable package)
4. **Validate**: Run Phase 0 validation checklist
5. **Iterate**: Move to Phase 1 upon completion (fill in template content)

### Phase-by-Phase Context Documents

Each phase will have its own detailed context document:
- `phase-0-context.md` - Package architecture implementation
- `phase-1-context.md` - MVP foundation (template content)
- `phase-2-context.md` - Core orchestration features
- `phase-3-context.md` - Full workflow implementation
- `phase-4-context.md` - Enhanced capabilities
- `phase-5-context.md` - Difficult feature adaptations

---

## Appendix A: Document References

| Document | Location | Purpose |
|----------|----------|---------|
| 01-omo-architecture-overview | planning-context/ | OmO architecture |
| 02-claude-code-architecture-comparison | planning-context/ | System comparison |
| 03-agent-hierarchy-and-types | planning-context/ | Agent mappings |
| 08-workflow-phases-and-gates | planning-context/ | Workflow details |
| 09-error-recovery-protocols | planning-context/ | Error handling |
| 10-task-management-patterns | planning-context/ | Task patterns |
| 11-tool-selection-matrix | planning-context/ | Tool selection |
| 14-direct-feature-mappings | planning-context/ | Quick wins |
| 15-adaptation-requirements | planning-context/ | Modifications |
| 16-impossible-features-and-workarounds | planning-context/ | Constraints |
| 17-implementation-priority-matrix | planning-context/ | Priorities |
| omo-to-claude-code-migration-guide | root | Migration guide |
| agents.md | root | Agent details |

---

## Appendix B: Complete CLAUDE.md Structure

Final CLAUDE.md will contain these sections:

1. Core Identity
2. Task Management Rules
3. Error Recovery Protocol (3-Strikes)
4. Workflow Phases (0-3)
5. Intent Classification
6. Agent Delegation Template
7. Model Selection Guidelines
8. Codebase Maturity Assessment
9. Exploration Phase Patterns
10. Completion Checking Protocol
11. Session Continuity
12. Context Management
13. Quality Standards
14. Tool Selection Quick Reference
15. Semantic Operations Guide
16. AST-grep Patterns
17. Advanced Automation Patterns
18. Project-Specific Context

---

## Appendix C: Package Distribution Strategy

### NPM Package: `muaddib-claude`

**Installation Methods:**

```bash
# Global installation (recommended)
npm install -g muaddib-claude

# Per-project (alternative)
npx muaddib-claude init
```

**Target Audience:**
- Claude Code users wanting structured orchestration
- Developers familiar with OmO patterns
- Teams wanting consistent AI coding assistance

**Distribution Channels:**
1. **NPM** (primary) - `npm install -g muaddib-claude`
2. **GitHub** - Source code + releases
3. **Homebrew** (future) - `brew install muaddib-claude`

**Versioning Strategy:**
- Semantic versioning (MAJOR.MINOR.PATCH)
- Templates versioned separately from CLI
- Backward compatibility for project configs

---

*Master Plan v1.1*
*Created: January 2026*
*Updated: Added Phase 0 (Package Architecture)*
*Based on: OmO Research (~350 KB, 31 documents)*
*Project: Muad'Dib - OmO-style orchestration for Claude Code*
