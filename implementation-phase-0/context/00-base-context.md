# Phase 0 Base Context

## Always Load This Document First

This document provides the foundational context for Phase 0: Package Architecture implementation.

---

## Phase 0 Overview

**Goal**: Create `muaddib-claude` - a distributable NPM package enabling OmO-style orchestration for Claude Code.

**Key Outcomes**:
1. Global installation via `npm install -g muaddib-claude`
2. Per-project initialization via `muaddib init`
3. Template-based configuration generation
4. CLI tooling for management and updates

---

## Architecture Summary

### Two-Layer Installation Model

```
GLOBAL LAYER (~/.muaddib/)
├── bin/          # CLI executables
├── lib/          # Core library files
│   ├── core/     # Orchestration rules, agent definitions
│   ├── hooks/    # Settings templates
│   ├── scripts/  # Helper shell scripts
│   └── templates/# Handlebars templates
├── skills/       # Claude Code skill definitions
└── package.json

PROJECT LAYER (per-project, generated by `muaddib init`)
├── CLAUDE.md                # Project orchestration rules
├── .claude/
│   ├── settings.json        # Hooks and permissions
│   ├── context.md           # Session context
│   └── critical-context.md  # Compaction context
└── .muaddib/
    ├── config.json          # Project config
    └── state/               # Session state
```

---

## NPM Package Structure

```
muaddib-claude/
├── package.json         # NPM config, dependencies, bin entry
├── README.md            # Documentation
├── LICENSE              # MIT license
├── bin/
│   └── muaddib.js       # CLI entry point (hashbang + require)
├── src/
│   ├── cli/
│   │   ├── index.js     # Command router (commander.js)
│   │   ├── install.js   # Global install command
│   │   ├── init.js      # Project init command
│   │   ├── update.js    # Update command
│   │   ├── doctor.js    # Health check command
│   │   └── config.js    # Config management
│   ├── lib/
│   │   ├── file-manager.js    # File operations
│   │   ├── template-engine.js # Handlebars rendering
│   │   ├── config-merger.js   # Config merging logic
│   │   └── validator.js       # Installation validation
│   └── utils/
│       ├── logger.js    # Colored console output
│       └── prompts.js   # inquirer wrappers
├── templates/           # Handlebars templates
├── scripts/             # Shell scripts for hooks
└── lib/                 # Core documentation files
```

---

## Technology Stack

| Component | Technology | Version |
|-----------|------------|---------|
| Runtime | Node.js | >=18.0.0 |
| CLI Framework | commander | ^11.0.0 |
| Templating | handlebars | ^4.7.8 |
| Prompts | inquirer | ^9.0.0 |
| Console Styling | chalk | ^5.3.0 |
| File Operations | fs-extra | ^11.0.0 |
| Testing | jest | ^29.0.0 |
| Linting | eslint | ^8.0.0 |

---

## CLI Commands Reference

| Command | Description |
|---------|-------------|
| `muaddib install` | Install/reinstall global components |
| `muaddib init` | Initialize in current project |
| `muaddib init --minimal` | Minimal init (CLAUDE.md only) |
| `muaddib init --full` | Full init with all features |
| `muaddib update` | Update global components |
| `muaddib update --project` | Update project files |
| `muaddib doctor` | Health check |
| `muaddib config` | View/edit configuration |
| `muaddib reset` | Reset project to defaults |
| `muaddib --version` | Show version |
| `muaddib --help` | Show help |

---

## Key Design Decisions

### 1. Handlebars for Templating
- Familiar mustache-like syntax
- Supports partials for modular templates
- Custom helpers for complex logic
- Widely used, well-documented

### 2. Commander.js for CLI
- Industry standard for Node.js CLIs
- Clean subcommand structure
- Built-in help generation
- Easy option parsing

### 3. Two-Layer Installation
- Global layer: Shared resources, CLI tools
- Project layer: Project-specific config
- Allows team customization per project
- Updates don't break project configs

### 4. Config Merging Strategy
- Global config provides defaults
- Project config overrides/extends
- Arrays (hooks, permissions) are concatenated
- Objects are deep merged

---

## File Relationships

```
package.json
    │
    └── "bin": { "muaddib": "./bin/muaddib.js" }
                      │
                      ▼
              bin/muaddib.js
                      │
                      └── requires: src/cli/index.js
                                        │
                    ┌───────────────────┼───────────────────┐
                    ▼                   ▼                   ▼
            src/cli/install.js    src/cli/init.js    src/cli/update.js
                    │                   │                   │
                    └───────────┬───────┴───────────────────┘
                                │
                    ┌───────────┼───────────┐
                    ▼           ▼           ▼
            src/lib/    src/lib/    src/lib/
            file-       template-   config-
            manager.js  engine.js   merger.js
                                        │
                                        ▼
                                templates/*.hbs
```

---

## Success Metrics

Phase 0 is successful when:

| Metric | Target |
|--------|--------|
| Global installation success | 100% |
| Project init success | 100% |
| CLI commands functional | All 9 |
| Template generation accuracy | 100% |
| Cross-platform (macOS + Linux) | Yes |
| Documentation complete | Yes |

---

## Reference Documents

For detailed specifications, refer to:

| Document | Location | Content |
|----------|----------|---------|
| Master Plan | `/MASTER-PLAN.md` | Full Phase 0 specification |
| Planning Context | `/planning-context/CLAUDE.md` | Implementation process |
| Research: Migration | `/omo-to-claude-code-migration-guide.md` | Feature mapping |
| Research: Hooks | `/hooks.md` | Hook system details |
| Research: Agents | `/agents.md` | Agent delegation |

---

## Coding Standards

When implementing Phase 0:

1. **ES Modules**: Use ES module syntax (`import`/`export`)
2. **Async/Await**: Use async functions for I/O operations
3. **Error Handling**: Always wrap async operations in try/catch
4. **Logging**: Use chalk for colored output
5. **Testing**: Write tests alongside implementation
6. **Documentation**: JSDoc comments on exported functions

---

## Critical Constraints

1. **Node.js 18+**: Use features available in Node 18+
2. **No Native Dependencies**: Pure JavaScript for cross-platform
3. **Backward Compatibility**: Project configs must survive updates
4. **Idempotent Operations**: Safe to run install/init multiple times
5. **Atomic File Operations**: Don't leave partial files on error

---

*Base context for Phase 0 implementation*
*Load task-specific context as needed per README.md markers*
