# Context: Templates (Tasks 4.1 - 4.4)

## Task Group Overview

This context covers implementing the Handlebars template system:
- Task 4.1: Create CLAUDE.md.hbs template
- Task 4.2: Create settings.json.hbs template
- Task 4.3: Create context templates
- Task 4.4: Implement template engine

---

## Handlebars Overview

Handlebars is a logic-less templating engine that supports:
- Variables: `{{variableName}}`
- Conditionals: `{{#if condition}}...{{/if}}`
- Loops: `{{#each array}}...{{/each}}`
- Partials: `{{> partialName}}`
- Helpers: `{{helperName arg1 arg2}}`

---

## Task 4.1: CLAUDE.md.hbs Template

### Template Variables

| Variable | Type | Description |
|----------|------|-------------|
| `projectName` | string | Name of the project |
| `projectType` | string | node/python/go/rust/other |
| `maturity` | string | disciplined/transitional/legacy/greenfield |
| `strictMode` | boolean | Enable extra guardrails |
| `version` | string | Muad'Dib version |

### Main Template

```handlebars
{{!-- templates/CLAUDE.md.hbs --}}
# {{projectName}} - Muad'Dib Orchestration

## Core Identity

You are an AI assistant following Muad'Dib orchestration patterns for Claude Code.
This project uses systematic workflows, intelligent agent delegation, and robust error recovery.

**Project Type**: {{projectTypeLabel projectType}}
**Codebase Maturity**: {{maturityLabel maturity}}
**Muad'Dib Version**: {{version}}
{{#if strictMode}}
**Mode**: Strict (Enhanced guardrails enabled)
{{/if}}

---

{{> orchestration-rules strictMode=strictMode}}

---

{{> workflow-phases}}

---

{{> agent-definitions}}

---

{{> quality-standards projectType=projectType strictMode=strictMode}}

---

## Project-Specific Context

### File Patterns

{{#if (eq projectType "node")}}
```
Source files:      src/**/*.{js,ts,jsx,tsx}
Test files:        **/*.{test,spec}.{js,ts}
Configuration:     *.config.{js,ts,json}
Package manifest:  package.json
```
{{else if (eq projectType "python")}}
```
Source files:      **/*.py
Test files:        tests/**/*.py, **/test_*.py
Configuration:     pyproject.toml, setup.py
Requirements:      requirements*.txt
```
{{else if (eq projectType "go")}}
```
Source files:      **/*.go
Test files:        **/*_test.go
Configuration:     go.mod, go.sum
```
{{else if (eq projectType "rust")}}
```
Source files:      src/**/*.rs
Test files:        tests/**/*.rs
Configuration:     Cargo.toml
```
{{else}}
```
[Document your project's file patterns here]
```
{{/if}}

### Conventions

{{#if (eq maturity "disciplined")}}
- Follow existing patterns EXACTLY
- Maintain code style consistency
- All changes require tests
- Documentation must be updated
{{else if (eq maturity "transitional")}}
- Follow new patterns for new code
- Respect existing patterns in legacy areas
- Add tests for new functionality
- Gradual migration when touching old code
{{else if (eq maturity "legacy")}}
- Be cautious with changes
- Propose cleanups when relevant
- Document unexpected behaviors
- Test more thoroughly due to lower coverage
{{else}}
- Establish best practices from the start
- Use modern patterns and tooling
- Comprehensive testing from day one
- Document architectural decisions
{{/if}}

---

*Generated by Muad'Dib v{{version}}*
*Based on OmO orchestration patterns*
```

---

### Partial Templates

#### templates/partials/orchestration-rules.hbs

```handlebars
## Orchestration Rules

### Task Management

1. **Use TodoWrite for any task with 3+ steps** - Track progress visibly
2. **Mark todos complete only when fully verified** - No premature completion
3. **Never stop with incomplete todos** - Continue until done or blocked
4. **Break complex work into atomic tasks** - One clear deliverable per todo

### Error Recovery (3-Strikes Rule)

After 3 consecutive failures on the same operation:

```
Strike 1 → Attempt operation
Strike 2 → Retry with adjustments
Strike 3 → Retry again
         │
         ▼ (3rd failure)
    ┌─────────┐
    │  STOP   │ → Halt all modifications
    └────┬────┘
         │
    ┌─────────┐
    │ REVERT  │ → git checkout (last working state)
    └────┬────┘
         │
    ┌─────────┐
    │DOCUMENT │ → Record failure details
    └────┬────┘
         │
    ┌─────────┐
    │ CONSULT │ → Task(Plan, opus) for guidance
    └────┬────┘
         │
    ┌─────────┐
    │ESCALATE │ → AskUserQuestion if still stuck
    └─────────┘
```

{{#if strictMode}}
### Strict Mode Rules

- **No modifications without tests** - Write tests first or alongside
- **Require explicit confirmation** for destructive operations
- **Enhanced validation** - Run full lint/typecheck on every edit
- **Conservative changes** - Smallest possible change to achieve goal
{{/if}}
```

#### templates/partials/workflow-phases.hbs

```handlebars
## Workflow Phases

### Phase 0: Intent Gate
**Purpose**: Classify and validate request before work begins

**Actions**:
1. Classify request type (Trivial/Explicit/Exploratory/Open-ended/Ambiguous)
2. For Ambiguous: AskUserQuestion for clarification
3. For Exploratory/Open-ended: Proceed to Phase 1
4. For Explicit: Skip to Phase 2B
5. For Trivial: Answer directly

---

### Phase 1: Codebase Assessment
**Purpose**: Evaluate project state for complex tasks

**Triggers**: Open-ended requests, unfamiliar codebases

**Actions**:
1. Assess codebase maturity
2. Identify existing patterns via Task(Explore)
3. Check dependencies
4. Understand project structure

---

### Phase 2A: Exploration & Research
**Purpose**: Gather context through parallel investigation

**Actions**:
1. Launch parallel exploration agents
2. Continue until sufficient context gathered

---

### Phase 2B: Implementation
**Purpose**: Execute the actual development work

**Actions**:
1. Create TodoWrite items for multi-step work
2. Handle core logic directly
3. Delegate specialized work appropriately
4. Track progress via TodoWrite
5. Validate each step before proceeding

---

### Phase 2C: Failure Recovery
**Purpose**: Handle persistent failures

**Trigger**: 3 consecutive failures on same operation

**Protocol**: STOP → REVERT → DOCUMENT → CONSULT → ESCALATE

---

### Phase 3: Completion
**Purpose**: Verify and deliver results

**Actions**:
1. Verify all TodoWrite items complete
2. Run quality checks
3. Verify deliverables match requirements
4. Clean up temporary files/states
5. Summarize accomplishments
```

#### templates/partials/agent-definitions.hbs

```handlebars
## Agent Delegation

Use the Task tool with appropriate specialization:

| Task Type | subagent_type | model | When to Use |
|-----------|---------------|-------|-------------|
| Codebase exploration | `Explore` | haiku | Finding files, understanding structure |
| Research/documentation | `general-purpose` | haiku | External lookups, documentation |
| Architecture decisions | `Plan` | opus | Complex design, multi-component analysis |
| Implementation planning | `Plan` | sonnet | Feature design, refactoring strategy |
| Security review | `security-engineer` | sonnet | Vulnerability analysis |
| Performance analysis | `performance-engineer` | sonnet | Optimization, profiling |
| Frontend work | `frontend-architect` | sonnet | UI/UX implementation |
| Backend design | `backend-architect` | sonnet | API design, data modeling |

### Delegation Prompt Template

When delegating via Task tool, structure prompts as:

1. **TASK**: [Specific, atomic goal]
2. **EXPECTED OUTCOME**: [Concrete deliverable]
3. **CONTEXT**: [Relevant file paths, patterns, constraints]
4. **MUST DO**: [Explicit requirements]
5. **MUST NOT DO**: [Forbidden actions]
6. **TOOLS ALLOWED**: [Optional whitelist]
7. **SUCCESS CRITERIA**: [How to know task is complete]
```

#### templates/partials/quality-standards.hbs

```handlebars
## Quality Standards

### Code Quality

- Match existing style exactly (indentation, naming, patterns)
- No TODO comments for core functionality
- No placeholder implementations - complete or don't start
{{#if (eq projectType "node")}}
- Run prettier/eslint after edits
- TypeScript: no `any` types, strict mode
{{else if (eq projectType "python")}}
- Run black/ruff after edits
- Type hints for public functions
{{else if (eq projectType "go")}}
- Run gofmt after edits
- Handle all errors explicitly
{{else if (eq projectType "rust")}}
- Run cargo fmt after edits
- No unwrap() in production code
{{/if}}

### Testing

{{#if strictMode}}
- All changes require tests
- Run full test suite before marking complete
- Coverage must not decrease
{{else}}
- Run existing tests before and after changes
- Add tests for new functionality
- Don't modify tests to make them pass
{{/if}}

### Documentation

- Update relevant docs when changing behavior
- Add comments only for non-obvious logic
- Keep README updated
```

---

## Task 4.2: settings.json.hbs Template

```handlebars
{{!-- templates/settings.json.hbs --}}
{
  "hooks": {
{{#if strictMode}}
    "PreToolUse": [
      {
        "matcher": "Edit|Write",
        "hooks": [{
          "type": "command",
          "command": "echo 'Pre-edit check for $FILE'"
        }]
      }
    ],
{{/if}}
    "PostToolUse": [
      {
        "matcher": "Edit|Write",
        "hooks": [
{{#if (eq projectType "node")}}
          {"type": "command", "command": "npx prettier --write \"$FILE\" 2>/dev/null || true"},
          {"type": "command", "command": "npx eslint --fix \"$FILE\" 2>/dev/null || true"}
{{else if (eq projectType "python")}}
          {"type": "command", "command": "black \"$FILE\" 2>/dev/null || true"},
          {"type": "command", "command": "ruff check --fix \"$FILE\" 2>/dev/null || true"}
{{else if (eq projectType "go")}}
          {"type": "command", "command": "gofmt -w \"$FILE\" 2>/dev/null || true"}
{{else if (eq projectType "rust")}}
          {"type": "command", "command": "rustfmt \"$FILE\" 2>/dev/null || true"}
{{else}}
          {"type": "command", "command": "echo 'Edited: $FILE'"}
{{/if}}
        ]
      }
    ]
  },
  "permissions": {
    "allow": [
{{#if (eq projectType "node")}}
      "Bash(git:*)",
      "Bash(npm:*)",
      "Bash(npx:*)",
      "Bash(node:*)"
{{else if (eq projectType "python")}}
      "Bash(git:*)",
      "Bash(python:*)",
      "Bash(python3:*)",
      "Bash(pip:*)",
      "Bash(pytest:*)"
{{else if (eq projectType "go")}}
      "Bash(git:*)",
      "Bash(go:*)",
      "Bash(make:*)"
{{else if (eq projectType "rust")}}
      "Bash(git:*)",
      "Bash(cargo:*)",
      "Bash(rustc:*)"
{{else}}
      "Bash(git:*)"
{{/if}}
    ],
    "deny": [
      "Bash(rm -rf /*:*)",
      "Bash(rm -rf ~:*)",
      "Bash(curl:*)",
      "Bash(wget:*)",
      "Bash(sudo:*)",
      "Read(.env*)",
      "Read(**/secrets/**)",
      "Write(.env*)",
      "Write(**/secrets/**)"
    ]
  }
}
```

---

## Task 4.3: Context Templates

### templates/context.md.hbs

```handlebars
# Project Context - {{projectName}}

*Auto-injected at session start via SessionStart hook*

## Project Overview

[Brief description of what this project does]

## Current State

- **Phase**: [Development/Testing/Production]
- **Active Work**: [Current focus areas]
- **Known Issues**: [Any blockers or concerns]

## Key Patterns

{{#if (eq projectType "node")}}
- Modules: ES Modules (import/export)
- Style: [Your style guide]
- Testing: Jest/Vitest
{{else if (eq projectType "python")}}
- Structure: [src layout / flat]
- Style: PEP 8, Black formatted
- Testing: pytest
{{else}}
[Document your key patterns]
{{/if}}

## Recent Decisions

- [Date]: [Decision and rationale]

## File Organization

```
[Add your project structure here]
```

---

*Update this file to maintain session context*
```

### templates/critical-context.md.hbs

```handlebars
# Critical Context - {{projectName}}

*Preserved during compaction via PreCompact hook*

## Never Forget

- Project uses Muad'Dib orchestration patterns
- Follow existing code conventions exactly
- Run quality checks after edits
{{#if strictMode}}
- STRICT MODE: All changes require tests
{{/if}}

## Current Objectives

[What we're currently working on]

## Key File Paths

[Important files being modified]

## Decisions Made This Session

[Key decisions that inform current work]

---

*This file is injected during context compaction*
*Keep it concise - only critical information*
```

### templates/config.json.hbs

```handlebars
{
  "projectName": "{{projectName}}",
  "projectType": "{{projectType}}",
  "maturity": "{{maturity}}",
  "strictMode": {{strictMode}},
  "muaddibVersion": "{{version}}",
  "initialized": "{{timestamp}}",
  "settings": {
    "autoFormat": true,
    "autoLint": true,
    "createBackups": true
  }
}
```

---

## Task 4.4: Template Engine

### Implementation

```javascript
// src/lib/template-engine.js

import Handlebars from 'handlebars';
import { readFileSync, readdirSync, existsSync } from 'fs';
import { join, basename } from 'path';
import { GLOBAL_TEMPLATES } from '../utils/paths.js';

// Compile and cache templates
const templateCache = new Map();
const partialsRegistered = false;

/**
 * Register custom Handlebars helpers
 */
function registerHelpers() {
  // Equality check
  Handlebars.registerHelper('eq', (a, b) => a === b);

  // Not equal
  Handlebars.registerHelper('neq', (a, b) => a !== b);

  // Project type label
  Handlebars.registerHelper('projectTypeLabel', (type) => {
    const labels = {
      node: 'Node.js / JavaScript',
      python: 'Python',
      go: 'Go',
      rust: 'Rust',
      other: 'General'
    };
    return labels[type] || type;
  });

  // Maturity label
  Handlebars.registerHelper('maturityLabel', (maturity) => {
    const labels = {
      disciplined: 'Disciplined',
      transitional: 'Transitional',
      legacy: 'Legacy',
      greenfield: 'Greenfield'
    };
    return labels[maturity] || maturity;
  });

  // Timestamp helper
  Handlebars.registerHelper('timestamp', () => {
    return new Date().toISOString();
  });

  // JSON stringify
  Handlebars.registerHelper('json', (obj) => {
    return JSON.stringify(obj, null, 2);
  });
}

/**
 * Register all partial templates
 */
function registerPartials() {
  if (partialsRegistered) return;

  const partialsDir = join(GLOBAL_TEMPLATES, 'partials');
  if (!existsSync(partialsDir)) return;

  const files = readdirSync(partialsDir);
  for (const file of files) {
    if (file.endsWith('.hbs')) {
      const name = basename(file, '.hbs');
      const content = readFileSync(join(partialsDir, file), 'utf8');
      Handlebars.registerPartial(name, content);
    }
  }
}

/**
 * Get compiled template (with caching)
 * @param {string} templateName - Template filename (e.g., 'CLAUDE.md.hbs')
 * @returns {HandlebarsTemplateDelegate}
 */
function getTemplate(templateName) {
  if (templateCache.has(templateName)) {
    return templateCache.get(templateName);
  }

  const templatePath = join(GLOBAL_TEMPLATES, templateName);
  const templateContent = readFileSync(templatePath, 'utf8');
  const compiled = Handlebars.compile(templateContent);

  templateCache.set(templateName, compiled);
  return compiled;
}

/**
 * Render a template with data
 * @param {string} templateName - Template filename
 * @param {Object} data - Data to pass to template
 * @returns {Promise<string>} - Rendered output
 */
export async function renderTemplate(templateName, data) {
  // Ensure helpers and partials are registered
  registerHelpers();
  registerPartials();

  // Add default values
  const contextData = {
    timestamp: new Date().toISOString(),
    ...data
  };

  // Get and execute template
  const template = getTemplate(templateName);
  return template(contextData);
}

/**
 * Clear template cache (useful for development)
 */
export function clearTemplateCache() {
  templateCache.clear();
}

/**
 * List available templates
 * @returns {string[]}
 */
export function listTemplates() {
  const files = readdirSync(GLOBAL_TEMPLATES);
  return files.filter(f => f.endsWith('.hbs') && !f.startsWith('_'));
}
```

---

## Acceptance Criteria

### Task 4.1 (CLAUDE.md.hbs)
- [ ] Template renders without errors
- [ ] All variables documented
- [ ] Partials included correctly
- [ ] Project type specific sections work
- [ ] Maturity specific sections work
- [ ] Strict mode sections conditional

### Task 4.2 (settings.json.hbs)
- [ ] Outputs valid JSON
- [ ] Project-type specific hooks
- [ ] Permissions configured correctly
- [ ] Strict mode adds extra checks

### Task 4.3 (context templates)
- [ ] context.md.hbs renders
- [ ] critical-context.md.hbs renders
- [ ] config.json.hbs outputs valid JSON

### Task 4.4 (template engine)
- [ ] Helpers registered correctly
- [ ] Partials loaded from directory
- [ ] Template caching works
- [ ] Error handling for missing templates
- [ ] All templates render correctly

---

*Context for Tasks 4.1, 4.2, 4.3, 4.4*
